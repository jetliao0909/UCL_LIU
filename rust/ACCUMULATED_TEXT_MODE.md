# 累積文字模式說明

## 問題背景

在輸入窗口模式中，選擇候選字後需要將文字貼上到遊戲。最初的設計是：
1. 選擇候選字
2. 自動切換焦點回遊戲
3. 發送 Ctrl+V 貼上
4. 切換焦點回輸入窗口

**問題**：
- 頻繁切換焦點不可靠
- 可能切換錯窗口
- 每打一個字就要切換一次，體驗差
- 在全屏遊戲中，自動切換焦點可能失敗

## 解決方案：累積文字模式

### 核心設計

**選擇候選字後，文字不會自動貼上到遊戲，而是累積在輸入窗口中。**

### 使用流程

1. **打開輸入窗口**
   - 按 `Ctrl+Space` 或 `Ctrl+Alt` 打開輸入窗口
   - 如果窗口沒有自動獲得焦點，點擊窗口或按 `Alt+Tab` 切換

2. **輸入字根並選擇候選字**
   - 在窗口中輸入字根（例如：`ucl`）
   - 使用數字鍵（1-9）選擇候選字，或按 `Space`/`Enter` 選擇第一個候選字
   - 選擇的候選字會累積在窗口下方的綠色區域

3. **繼續輸入更多字**
   - 可以連續輸入多個字，所有選擇的候選字都會累積在一起
   - 例如：輸入 `ucl` 選擇「肥」，輸入 `liu` 選擇「米」，累積文字會變成「肥米」

4. **複製到剪貼簿**
   - 輸入完成後，按 `Ctrl+V` 將累積的文字複製到剪貼簿
   - 窗口會顯示提示訊息

5. **貼上到遊戲**
   - 切換回遊戲（按 `Alt+Tab` 或點擊遊戲窗口）
   - 在遊戲中按 `Ctrl+V` 貼上全部文字

6. **清除累積文字（可選）**
   - 如果需要重新輸入，按 `Ctrl+C` 清除累積的文字
   - 關閉窗口時，累積的文字不會自動清除，可以繼續使用

### 視覺提示

- **綠色區域**：顯示累積的文字（待貼上）
- **提示文字**：顯示操作說明（Ctrl+V 複製到剪貼簿，Ctrl+C 清除）

### 優點

✅ **可靠**
   - 不需要自動切換焦點
   - 不會切換錯窗口
   - 用戶完全控制何時貼上

✅ **用戶體驗好**
   - 可以一次輸入多個字，然後一次性貼上
   - 可以檢查文字後再貼上
   - 不需要頻繁切換焦點

✅ **適用於所有遊戲**
   - 不依賴自動切換焦點
   - 適用於全屏遊戲
   - 適用於窗口模式遊戲

### 缺點

⚠️ **需要手動操作**
   - 需要手動按 `Ctrl+V` 複製到剪貼簿
   - 需要手動切換回遊戲
   - 需要手動按 `Ctrl+V` 貼上

⚠️ **多一步操作**
   - 比自動貼上多一步操作
   - 但換來的是更高的可靠性

## 技術實現

### 數據結構

```rust
pub struct GuiWindow {
    // ...
    accumulated_text: Arc<Mutex<String>>,  // 累積的文字（待貼上到遊戲）
    accumulated_text_frame: Frame,  // 累積文字顯示框
}
```

### 選擇候選字時

```rust
// 選擇候選字後，累積到文字緩衝區（不自動貼上）
{
    let mut acc_text = accumulated_text.lock().unwrap();
    acc_text.push_str(&text);
    info!("✅ 選擇候選字 {}: {}，累積文字: {}", num, text, acc_text);
}
```

### Ctrl+V 處理

```rust
// 處理 Ctrl+V（手動貼上累積的文字到剪貼簿）
if app::event_state().contains(fltk::enums::Shortcut::Ctrl) && key == Key::from_char('v') {
    let text_to_copy = {
        let acc_text = accumulated_text.lock().unwrap();
        acc_text.clone()
    };
    
    if !text_to_copy.is_empty() {
        // 複製累積的文字到剪貼簿
        use arboard::Clipboard;
        if let Ok(mut clipboard) = Clipboard::new() {
            if clipboard.set_text(&text_to_copy).is_ok() {
                info!("✅ 已複製累積文字到剪貼簿: {}", text_to_copy);
                info!("💡 提示：請切換回遊戲，按 Ctrl+V 貼上文字");
                // 不清除累積文字，讓用戶可以多次貼上
            }
        }
    }
}
```

### Ctrl+C 處理

```rust
// 處理 Ctrl+C（清除累積的文字）
if app::event_state().contains(fltk::enums::Shortcut::Ctrl) && key == Key::from_char('c') {
    let mut acc_text = accumulated_text.lock().unwrap();
    if !acc_text.is_empty() {
        acc_text.clear();
        info!("✅ 已清除累積文字");
    }
}
```

## 使用範例

### 範例 1：輸入一個字

1. 打開輸入窗口
2. 輸入 `ucl`，按 `Space` 選擇「肥」
3. 按 `Ctrl+V` 複製到剪貼簿
4. 切換回遊戲，按 `Ctrl+V` 貼上

### 範例 2：輸入多個字

1. 打開輸入窗口
2. 輸入 `ucl`，按 `Space` 選擇「肥」（累積：`肥`）
3. 輸入 `liu`，按 `Space` 選擇「米」（累積：`肥米`）
4. 輸入 `shu`，按 `1` 選擇「輸」（累積：`肥米輸`）
5. 輸入 `ru`，按 `Space` 選擇「入」（累積：`肥米輸入`）
6. 輸入 `fa`，按 `Space` 選擇「法」（累積：`肥米輸入法`）
7. 按 `Ctrl+V` 複製到剪貼簿
8. 切換回遊戲，按 `Ctrl+V` 貼上全部文字

### 範例 3：重新輸入

1. 輸入完成後，發現有錯誤
2. 按 `Ctrl+C` 清除累積的文字
3. 重新輸入正確的文字
4. 按 `Ctrl+V` 複製到剪貼簿
5. 切換回遊戲，按 `Ctrl+V` 貼上

## 與自動貼上模式的對比

| 特性 | 自動貼上模式 | 累積文字模式 |
|------|------------|------------|
| **可靠性** | ⚠️ 可能失敗 | ✅ 完全可靠 |
| **切換焦點** | ⚠️ 需要自動切換 | ✅ 不需要自動切換 |
| **操作步驟** | ✅ 較少 | ⚠️ 較多 |
| **用戶控制** | ⚠️ 較少 | ✅ 完全控制 |
| **適用範圍** | ⚠️ 可能不適用於全屏遊戲 | ✅ 適用於所有遊戲 |
| **錯誤處理** | ⚠️ 可能切換錯窗口 | ✅ 不會切換錯窗口 |

## 結論

累積文字模式雖然需要多一步操作，但換來的是：
- **更高的可靠性**
- **更好的用戶體驗**（可以一次輸入多個字）
- **適用於所有遊戲**（包括全屏遊戲）

這是目前最可靠的方案，特別適合需要輸入多個字的場景。

