# 遊戲輸入兼容性說明

## 貼上模式（剪貼簿 + Ctrl+V）的優勢

在遊戲環境中，**貼上模式確實具有最高的兼容性**，原因如下：

### 1. 模擬真實用戶操作

貼上模式（剪貼簿 + Ctrl+V）模擬的是真實用戶的操作流程：
1. 用戶複製文字到剪貼簿（正常操作）
2. 用戶按下 Ctrl+V 貼上（標準快捷鍵）

這種方式與真實用戶行為完全一致，不容易被反作弊系統檢測為異常。

### 2. 遊戲支援度高

大多數遊戲都支援 Ctrl+V 貼上功能：
- ✅ **MMORPG**：大多數都支援聊天框貼上
- ✅ **MOBA**：支援聊天輸入框貼上
- ✅ **FPS**：支援文字聊天貼上
- ✅ **策略遊戲**：支援文字輸入貼上
- ✅ **沙盒遊戲**：支援文字輸入貼上

### 3. 反作弊系統兼容性

- **較少檢測**：貼上操作是正常的用戶行為，反作弊系統通常不會攔截
- **不會觸發異常檢測**：不像直接 SendInput 可能被視為自動化工具
- **符合用戶習慣**：玩家經常使用 Ctrl+V 貼上，這是標準操作

### 4. 與直接輸入模式比較

| 特性 | 貼上模式 | 直接輸入模式 |
|------|---------|-------------|
| **兼容性** | ⭐⭐⭐⭐⭐ 最高 | ⭐⭐⭐ 中等 |
| **速度** | ⭐⭐⭐ 較慢（需要剪貼簿操作） | ⭐⭐⭐⭐⭐ 最快 |
| **反作弊檢測** | ⭐⭐⭐⭐⭐ 幾乎不會被檢測 | ⭐⭐ 可能被檢測 |
| **遊戲支援** | ⭐⭐⭐⭐⭐ 幾乎所有遊戲都支援 | ⭐⭐⭐ 部分遊戲可能不支援 |
| **剪貼簿影響** | ⚠️ 會覆蓋剪貼簿內容 | ✅ 不影響剪貼簿 |

## 當前實現

目前的實現使用貼上模式：

```rust
pub fn send_text_paste(&mut self, text: &str) -> Result<()> {
    // 1. 複製文字到剪貼簿
    let mut clipboard = Clipboard::new()?;
    clipboard.set_text(text)?;
    
    // 2. 等待剪貼簿更新
    thread::sleep(Duration::from_millis(10));
    
    // 3. 發送 Ctrl+V（使用 SendInput）
    // 按下 Ctrl -> 按下 V -> 釋放 V -> 釋放 Ctrl
}
```

## 遊戲輸入的特殊情況

### 1. 全螢幕遊戲

- ✅ **貼上模式**：通常可以正常工作
- ⚠️ **注意**：某些全螢幕遊戲可能會攔截 Ctrl+V，但這種情況較少見

### 2. 反作弊系統

常見的反作弊系統（如 BattlEye、EasyAntiCheat、Vanguard）：
- ✅ **貼上模式**：通常不會被檢測，因為是正常的用戶操作
- ⚠️ **直接輸入**：可能被檢測為自動化工具

### 3. 遊戲內聊天系統

大多數遊戲的聊天系統都支援：
- ✅ Ctrl+V 貼上
- ✅ Shift+Insert 貼上（部分遊戲）
- ✅ 右鍵貼上（部分遊戲）

## 已知限制

### 貼上模式的限制

1. **剪貼簿內容會被覆蓋**
   - 解決方案：可以考慮保存原始剪貼簿內容，使用後恢復（但會增加複雜度）

2. **速度較慢**
   - 需要剪貼簿操作 + 等待時間 + Ctrl+V 組合鍵
   - 但對於輸入法來說，這個速度通常可以接受

3. **某些遊戲可能禁用剪貼簿**
   - 極少數遊戲可能會禁用剪貼簿操作
   - 這種情況下，直接輸入模式也無法工作

### 直接輸入模式的限制

1. **可能被遊戲攔截**
   - 某些遊戲使用 DirectInput 或 Raw Input，可能不會接收 SendInput

2. **可能被反作弊系統檢測**
   - 某些反作弊系統會檢測異常的輸入模式

3. **Unicode 字符處理複雜**
   - 需要正確處理 Unicode 字符的輸入
   - 不同遊戲可能有不同的字符編碼要求

## 建議

### 對於遊戲輸入

1. **優先使用貼上模式**（當前實現）
   - 兼容性最高
   - 不容易被檢測
   - 支援度最好

2. **保留直接輸入模式作為備選**
   - 可以作為配置選項
   - 用於特殊情況或非遊戲環境

3. **考慮添加配置選項**
   - 讓用戶可以選擇輸入模式
   - 針對特定遊戲可以配置不同的模式

## 遊戲輸入的核心問題與完整解決方案

### 問題 1：熱鍵被遊戲攔截

**問題：** 在遊戲模式下，如果不攔截按鍵，熱鍵也會被遊戲先攔截掉，無法觸發輸入法。

**解決方案：優先攔截觸發熱鍵**
- 在鍵盤鉤子中，優先檢查是否為觸發熱鍵（在遊戲模式檢查之前）
- 如果是觸發熱鍵，就攔截並處理，不讓遊戲收到

### 問題 2：後續輸入被遊戲攔截（關鍵問題）

**問題：** 即使熱鍵能夠觸發，但後續的輸入（字根輸入）還是會被遊戲攔截，因為在遊戲模式下，我們讓其他按鍵通過。

**⚠️ 關鍵限制：WH_KEYBOARD_LL 無法攔截 Raw Input**

**重要說明：**
- `WH_KEYBOARD_LL` 只能攔截通過 **Windows 消息系統**的按鍵
- **無法攔截 Raw Input 或 DirectInput** 的輸入
- 如果遊戲使用 Raw Input，即使我們攔截了 Windows 消息，遊戲還是能收到原始輸入
- 這是 Windows 系統架構的根本限制

**實際情況：**
1. **遊戲使用標準 Windows 消息**：我們的攔截是有效的 ✅
2. **遊戲使用 Raw Input/DirectInput**：我們的攔截可能無效 ⚠️
   - 遊戲直接從驅動層獲取輸入
   - 即使我們攔截了 Windows 消息，遊戲還是能收到原始輸入
   - 這意味著輸入法可能無法正常工作

**解決方案：臨時啟用模式（有限效果）**

**工作流程：**
1. **遊戲模式下**：不攔截按鍵（讓遊戲操作正常）
2. **用戶按熱鍵**（如 `Ctrl+Shift+F`）→ 被攔截，觸發臨時啟用
3. **臨時啟用後**：切換到正常模式（開始攔截按鍵）
4. **用戶輸入字根**：
   - **如果遊戲使用標準 Windows 消息**：輸入法可以正常處理 ✅
   - **如果遊戲使用 Raw Input**：輸入法可能無法攔截，遊戲還是能收到按鍵 ⚠️
5. **輸入完成**（Space/Enter 送出）或**取消**（ESC）後，切換回遊戲模式

**⚠️ 重要限制：**
- 對於使用 Raw Input 的遊戲，臨時啟用模式可能**無法完全阻止遊戲接收按鍵**
- 這取決於遊戲的輸入處理方式
- 需要實際測試才能確定是否有效

**實現要點：**

```rust
// 狀態管理
thread_local! {
    static GAME_MODE: std::cell::RefCell<bool> = std::cell::RefCell::new(false);
    static TEMP_ENABLED: std::cell::RefCell<bool> = std::cell::RefCell::new(false); // 臨時啟用標誌
}

fn process_keyboard_event(...) -> Result<bool> {
    // 1. 首先檢查是否為觸發熱鍵（優先級最高）
    if is_trigger_hotkey(vk_code, modifiers) {
        if is_game_mode() {
            // 在遊戲模式下，觸發臨時啟用
            TEMP_ENABLED.with(|t| *t.borrow_mut() = true);
            GAME_MODE.with(|g| *g.borrow_mut() = false); // 臨時切換到正常模式
            info!("臨時啟用輸入法（從遊戲模式）");
        }
        return Ok(true); // 攔截熱鍵
    }
    
    // 2. 檢查是否為臨時啟用模式
    let temp_enabled = TEMP_ENABLED.with(|t| *t.borrow());
    if temp_enabled {
        // 臨時啟用模式下，正常處理輸入（攔截按鍵）
        // ... 正常模式的輸入處理 ...
        
        // 檢查是否應該結束臨時啟用
        if should_end_temp_mode(...) {
            TEMP_ENABLED.with(|t| *t.borrow_mut() = false);
            GAME_MODE.with(|g| *g.borrow_mut() = true); // 切換回遊戲模式
            info!("結束臨時啟用，切換回遊戲模式");
        }
        return Ok(true); // 攔截按鍵，正常處理
    }
    
    // 3. 檢查是否為遊戲模式
    if is_game_mode() {
        // 讓其他按鍵通過（但熱鍵已經在上面被攔截了）
        return Ok(false);
    }
    
    // 4. 正常模式處理...
}
```

**結束臨時啟用的條件：**
- 輸入完成：按 Space/Enter 送出候選字後
- 取消輸入：按 ESC 清除輸入後
- 可選：超時自動結束（如 30 秒無操作）

**優點：**
- ✅ 熱鍵可以正常觸發（優先攔截）
- ✅ 對於使用標準 Windows 消息的遊戲，後續輸入可以正常處理
- ✅ 輸入完成後自動切換回遊戲模式
- ✅ 不需要額外的 GUI
- ✅ 實現相對簡單

**缺點：**
- ⚠️ **對於使用 Raw Input 的遊戲，可能無法完全阻止遊戲接收按鍵**
- ⚠️ 在臨時啟用期間，遊戲操作會被中斷（但這是必要的）
- ⚠️ 需要管理臨時啟用狀態
- ⚠️ 效果取決於遊戲的輸入處理方式，需要實際測試

### 替代方案：輸入窗口模式（推薦用於 Raw Input 遊戲）

如果遊戲使用 Raw Input，臨時啟用模式可能無法完全阻止遊戲接收按鍵。在這種情況下，輸入窗口模式是更好的選擇：

**工作流程：**
1. 用戶按熱鍵 → 彈出浮動輸入窗口
2. **輸入窗口獲得焦點**，處理鍵盤輸入
3. 用戶在窗口中輸入**完整的字根**（例如 "ucl"）
4. 顯示候選字列表
5. 用戶選擇候選字（按 Space 選擇第一個，或按數字鍵選擇）
6. **選擇後，一次性貼上到遊戲**（使用 Ctrl+V）
7. 可以繼續輸入下一個字，或按 ESC/關閉按鈕關閉窗口

**重要說明：不是每打一個字就貼上一次**
- ✅ 用戶在窗口中輸入**完整的字根**（例如 "ucl"）
- ✅ 選擇候選字後，**一次性貼上**（例如 "肥"）
- ✅ 可以繼續輸入下一個字根，不需要關閉窗口
- ✅ 只有當用戶選擇候選字時，才會貼上到遊戲
- ✅ 可以連續輸入多個字，每個字選擇後才貼上

**使用範例：**
1. 按熱鍵 `Ctrl+Shift+F` → 彈出輸入窗口
2. 輸入 "ucl" → 顯示候選字：1.肥 2.米 3....
3. 按 Space → 選擇 "肥"，貼上到遊戲
4. 繼續輸入 "mi" → 顯示候選字：1.米 2....
5. 按 Space → 選擇 "米"，貼上到遊戲
6. 按 ESC → 關閉輸入窗口

**為什麼輸入窗口模式更有效：**
- ✅ **窗口獲得焦點時，輸入會被窗口接收**，而不是遊戲
- ✅ 即使遊戲使用 Raw Input，當窗口有焦點時，輸入也會被窗口處理
- ✅ 不會中斷遊戲操作（窗口處理輸入）
- ✅ 可以連續輸入多個字，體驗較好

**缺點：**
- ⚠️ 需要 GUI 實現
- ⚠️ 開發工作量較大
- ⚠️ 需要管理窗口焦點
- ⚠️ 需要切換焦點到輸入窗口（但這是必要的）

**結論：**
- 對於使用**標準 Windows 消息**的遊戲：臨時啟用模式可能有效
- 對於使用**Raw Input**的遊戲：輸入窗口模式更可靠

## 未來改進方向

1. **輸入窗口模式**（推薦優先實現）
   - 創建浮動輸入窗口
   - 窗口焦點管理
   - 候選字顯示和選擇
   - **對於 Raw Input 遊戲更可靠**
   - **支持連續輸入多個字，每個字選擇後才貼上**

2. **臨時啟用模式實現**（可選，效果有限）
   - 實現熱鍵觸發臨時啟用
   - 實現自動切換回遊戲模式
   - 處理各種邊界情況
   - **注意：對於 Raw Input 遊戲可能無效**

3. **智能模式切換**
   - 檢測當前應用程式
   - 針對遊戲自動使用貼上模式
   - 針對普通應用程式可以使用直接輸入模式（更快）

4. **剪貼簿內容保護**
   - 保存原始剪貼簿內容
   - 使用後恢復（可選功能）

5. **多種貼上方式支援**
   - Ctrl+V（當前）
   - Shift+Insert（備選）
   - 右鍵貼上（如果可能）

## 技術限制總結

### WH_KEYBOARD_LL 的限制

1. **只能攔截 Windows 消息系統的按鍵**
   - 無法攔截 Raw Input
   - 無法攔截 DirectInput
   - 這是 Windows 系統架構的根本限制

2. **實際效果取決於遊戲的輸入處理方式**
   - 使用標準 Windows 消息的遊戲：攔截有效 ✅
   - 使用 Raw Input 的遊戲：攔截可能無效 ⚠️

3. **解決方案選擇**
   - **輸入窗口模式**：對於 Raw Input 遊戲更可靠（窗口獲得焦點時處理輸入）
   - **臨時啟用模式**：對於標準 Windows 消息遊戲可能有效，但需要實際測試

### 建議

1. **優先實現輸入窗口模式**
   - 兼容性最好
   - 對於 Raw Input 遊戲也有效
   - 雖然需要 GUI，但更可靠

2. **臨時啟用模式作為備選**
   - 可以實現，但需要實際測試效果
   - 對於某些遊戲可能有效，對於 Raw Input 遊戲可能無效

## 參考資料

- [Windows SendInput API](https://docs.microsoft.com/en-us/windows/win32/api/winuser/nf-winuser-sendinput)
- [Windows Raw Input](https://docs.microsoft.com/en-us/windows/win32/inputdev/raw-input)
- [WH_KEYBOARD_LL Hook](https://docs.microsoft.com/en-us/windows/win32/winmsg/lowlevelkeyboardproc)
- [遊戲輸入處理最佳實踐](https://docs.microsoft.com/en-us/windows/win32/inputdev/user-input)
- [反作弊系統檢測機制](https://www.battleye.com/)

