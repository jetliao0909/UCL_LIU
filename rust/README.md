# 肥米輸入法 - Rust 版本 MVP

這是肥米輸入法的 Rust 重寫版本，目前處於 MVP（最小可行產品）階段。

## 功能狀態

### ✅ 已實現
- [x] 專案結構設置
- [x] 基本模組架構
- [x] 字碼表載入（JSON 格式，大小寫不區分）
- [x] Windows 低階鍵盤鉤子
- [x] 字根輸入處理（A-Z，自動轉為小寫）
- [x] 候選字查詢和選擇（數字鍵 0-9）
- [x] 特殊按鍵處理（Backspace、Space、Enter、ESC）
- [x] Shift 鍵切換攔截 / 英模式（單獨按一下 Shift 切換，Shift+其他鍵仍可當組合鍵）
- [x] F4 鍵退出功能
- [x] 系統托盤退出選項（與 F4 鍵行為一致）
- [x] 鍵盤輸入模擬（剪貼簿貼上模式）
  - 在鍵盤鉤子內部只排隊要貼上的文字，實際的剪貼簿操作與 Ctrl+V 由主迴圈統一執行，避免在 `WH_KEYBOARD_LL` 回呼裡做耗時工作導致卡死
- [x] 系統托盤圖示框架
- [x] 單一實例鎖定機制（使用文件鎖定防止重複執行）
- [x] GUI 狀態列視窗（右下角顯示字根與候選字，取代舊的遊戲模式候選視窗）
- [x] **遊戲模式窗口**（支援 Raw Input 遊戲）
  - 窗口獲得焦點時直接接收鍵盤輸入，不依賴鍵盤鉤子
  - 能夠繞過 Raw Input 限制，支援使用 Raw Input 的遊戲
  - 使用 `Ctrl+Space` 或 `Ctrl+Alt` 打開/關閉遊戲模式窗口
- [x] 單元測試覆蓋（包含遊戲模式窗口測試）

### 🚧 進行中
- [ ] 更完整的 GUI 介面與設定視窗

### 📋 待實現
- [ ] 配置檔案讀寫（INI 格式）
- [ ] 同音字功能
- [ ] 簡繁轉換
- [ ] 自定詞庫
- [ ] 打字音效
- [ ] 特殊應用程式處理（putty、notepad 等）

## 編譯要求

- Rust 1.70+ 
- Windows SDK（Windows 10 SDK 或更高版本推薦）
- Visual Studio Build Tools（用於編譯 Windows crates）

## Windows 版本支援

- ✅ **Windows 10** - 完全支援並測試
- ✅ **Windows 11** - 完全支援並測試
- ⚠️ **Windows 7** - 理論支援，但未充分測試（已停止支援）

詳細的兼容性說明請參考 [WINDOWS_COMPATIBILITY.md](WINDOWS_COMPATIBILITY.md)

## 編譯指令

```bash
cd rust
cargo build --release
```

## 執行

編譯後的可執行檔位於 `target/release/uclliu.exe`

需要準備：
- `liu.json` - 字碼表檔案（**必須**與執行檔放在同一目錄）
- `pinyi.txt` - 同音字表（可選，與執行檔同目錄）

**注意**：字典檔必須與執行檔放在同一目錄，程式不會從其他位置載入字典檔。

**啟動顯示行為**：程式啟動時不會自動顯示遊戲模式窗口，需要按 `Ctrl+Space` 或 `Ctrl+Alt` 手動開啟。

### 單一實例鎖定

程序啟動時會創建 `UCLLIU.lock` 文件並獲取獨占鎖，以防止重複執行：

**為什麼需要文件？**
- 文件鎖定機制需要一個實際的文件對象作為載體
- `fs2::FileExt::try_lock_exclusive()` 是對文件句柄的操作，必須先打開文件才能鎖定
- 鎖是附加在文件句柄上的，不是文件名；當句柄關閉時，鎖會自動釋放
- 文件內容不重要，文件只是鎖的載體

**工作原理：**
- 如果已有實例在運行，新實例會檢測到鎖已被持有，並立即退出
- 當程序正常退出時，文件鎖會自動釋放（文件句柄被 drop）
- 如果程序異常退出，文件鎖也會由操作系統自動釋放
- 程序退出時會自動刪除 `UCLLIU.lock` 文件（清理殘留文件）

## 開發筆記

### 鍵盤鉤子實作注意事項

Windows 鍵盤鉤子回調函數是靜態函數，無法直接訪問實例變數。需要使用以下方式之一：
1. 使用 `thread_local` 存儲狀態（本專案採用的方式）
2. 使用全域變數（`Arc<Mutex<...>>`）
3. 使用 Windows 的 `SetWindowLongPtr` 存儲指標

同時需特別注意：

- **不要在 `WH_KEYBOARD_LL` 回呼裡做耗時或可能阻塞的操作**  
  - 本專案將「送出候選字 → 複製到剪貼簿 → 模擬 Ctrl+V」拆成兩段：
    - 鍵盤鉤子只計算出要送出的文字，寫入 `AppState::pending_paste_text`
    - 主訊息迴圈在安全位置讀出該文字並呼叫 `InputSimulator::send_text_paste`
  - 這樣可以避免在鉤子執行緒裡卡在剪貼簿或系統呼叫，導致整個系統鍵盤卡死
- **鉤子不再直接鎖 GUI 管理器**  
  - GUI 視窗在顯示 / 隱藏 / 焦點變化時，更新兩個原子旗標：
    - `gui_visible: AtomicBool`：遊戲模式窗口是否顯示
    - `gui_has_focus: AtomicBool`：遊戲模式窗口是否有焦點
  - 鍵盤鉤子只讀這兩個旗標，即可判斷：
    - 若視窗「可見且有焦點」→ 放行按鍵給遊戲模式窗口處理
    - 若視窗「可見但無焦點」→ 仍由鉤子攔截處理（遊戲模式）
  - 如此避免在鉤子執行緒中 `lock()` GUI 相關的 `Mutex` 造成死鎖

### 已實現功能說明

1. **字根輸入處理**
   - 支援 A-Z 字母鍵輸入
   - 自動轉為小寫（字根查詢時大小寫無分別）
   - 最多 5 碼字根

2. **候選字選擇**
   - 數字鍵 0-9 選擇候選字
   - Space 鍵：選擇第一個候選字並清除輸入
   - Enter 鍵：選擇第一個候選字並清除輸入（與 Space 行為一致）
   - **補碼機制**：
     - 輸入 `v`：如果當前字根 + `v` 不在字典中，但當前字根存在且候選字數量 >= 2，則選擇候選2（第2個候選字），等待 Space 鍵送出
     - 輸入 `r`：如果當前字根 + `r` 不在字典中，但當前字根存在且候選字數量 >= 3，則選擇候選3（第3個候選字），等待 Space 鍵送出
     - 輸入 `s`：如果當前字根 + `s` 不在字典中，但當前字根存在且候選字數量 >= 4，則選擇候選4（第4個候選字），等待 Space 鍵送出
     - 輸入 `f`：如果當前字根 + `f` 不在字典中，但當前字根存在且候選字數量 >= 5，則選擇候選5（第5個候選字），等待 Space 鍵送出
     - 輸入 `w`：如果當前字根 + `w` 不在字典中，但當前字根存在且候選字數量 >= 6，則選擇候選6（第6個候選字），等待 Space 鍵送出
     - 補碼選擇後不會立即送出，需要按 Space 鍵才會送出選中的候選字
     - **觸發條件**：
       - 如果當前字根 + 補碼長度 < 5：檢查是否有以該組合開頭的更長字根；如果沒有，則觸發補碼；如果有，則不觸發（讓用戶繼續輸入）
       - 如果當前字根 + 補碼長度 = 5：如果不在字典中，則觸發補碼（因為無法繼續輸入更長的字根）
   - **符號輸入**（與 Python 版本一致，完全依賴字典表查找）：
     - 輸入符號（例如點號 `.` 或逗號 `,`）：
       - 如果當前有字根，先查找 字根+符號 的組合（例如 `s.` 對應 `？`，`..` 對應 `：`）
       - 如果當前沒有字根，先將符號添加到字根中，然後查找組合；如果組合不存在，再查找單獨符號
     - 符號映射完全依賴字典表（`liu.json`），不進行硬編碼處理，與 Python 版本行為一致
     - 字典表中的符號映射範例：
       - `s.` 對應 `？`（問號）
       - `.` 對應 `。`（句號）
       - `,` 對應 `，`（逗號）
       - `..` 對應 `：`（全形冒號）
       - `.,` 對應 `；`（全形分號）
     - **連續輸入符號支持**：
       - 輸入 `..`（兩個點號）→ 自動查找 `".."` → `"："`（全形冒號）
       - 輸入 `.,`（點號+逗號）→ 自動查找 `".,"` → `"；"`（全形分號）
     - 符號選擇後不會立即送出，需要按 Space 鍵才會送出選中的符號

3. **特殊按鍵**
   - Backspace：刪除最後一個字根
   - ESC：清除當前輸入
   - Shift：切換攔截 / 英模式（行為與 Python 版一致）
     - **單獨按一下 Shift**（期間沒有搭配其他鍵）：
       - 在放開 Shift 時切換模式（攔截模式 ↔ 英模式），並清除現有字根
     - **Shift + 其他鍵（例如 Shift+1, Shift+2, Shift+A）**：
       - 視為一般組合鍵，不切換模式，按鍵事件全部放行給系統
       - **即使在英模式（不攔截）下，只要 Shift 被按著期間有輸入過其他鍵，放開 Shift 也不會切換模式**（用於正常輸入大寫與上排符號）
     - 在攔截模式下，實際輸出的大小寫由輸入法控制；在英模式下，大小寫同一般系統鍵盤（Shift / CapsLock 都會生效）
   - **Ctrl 組合鍵支援**：當 Ctrl 鍵按下時，所有後續按鍵都會讓事件通過，確保 Ctrl+C、Ctrl+V、Ctrl+A 等組合鍵能正常工作
     - 這與 Python 版本的實現一致，確保在攔截模式下也能正常使用 Ctrl 組合鍵
   - Space：選擇第一個候選字並清除輸入
   - Enter：選擇第一個候選字並清除輸入（與 Space 行為一致）
   - F4：退出程式（無論是攔截模式還是不攔截模式，都能退出）
  - 顯示/隱藏 GUI 狀態列：`Ctrl+Space` 或 `Ctrl+Alt`（盡量在桌面與遊戲中都能顯示右下角狀態列）
  - **遊戲模式窗口**（支援 Raw Input 遊戲）：
    - 按 `Ctrl+Space` 或 `Ctrl+Alt` 打開遊戲模式窗口
    - 啟動時預設不顯示，需要手動使用熱鍵開啟
    - **手動點擊遊戲模式窗口給予焦點**（窗口不會自動獲得焦點）
    - 窗口獲得焦點後，直接接收鍵盤輸入（不依賴鍵盤鉤子）
    - **使用流程**：
      1. 在窗口中輸入字根，選擇候選字（數字鍵或 Space）
      2. 選擇的候選字會累積在窗口下方的綠色區域，並**自動複製到剪貼簿**
      3. 可以連續輸入多個字，所有文字都會自動累積並複製到剪貼簿
      4. 輸入完成後，切換回遊戲，按 `Ctrl+V` 貼上全部文字
      5. 按 `Enter` 清除累積的文字（如果需要重新輸入）
      6. 按 `ESC` 清除當前輸入的字根（但不關閉窗口，也不清除累積的文字）
      7. 按 `Ctrl+Space` 或 `Ctrl+Alt` 關閉遊戲模式窗口
    - **為什麼採用累積模式？**：
      - 避免頻繁切換焦點（更可靠）
      - 不會切換錯窗口
      - 用戶可以檢查文字後再貼上
      - 可以一次輸入多個字，然後一次性貼上
      - **自動複製到剪貼簿**：選擇候選字後自動複製，無需手動操作
    - **為什麼能支援 Raw Input 遊戲？**：窗口有焦點時，鍵盤事件直接發送到窗口，繞過 Raw Input 限制
    - **注意**：Windows 有前台窗口限制，在全屏遊戲中可能需要手動切換焦點（詳細說明請參考 [INPUT_WINDOW_FOCUS.md](INPUT_WINDOW_FOCUS.md)）
  - 系統托盤退出選項：點擊系統托盤圖示的「退出」選項，行為與 F4 鍵完全一致（設置退出標誌並調用 `PostQuitMessage`）

4. **攔截模式行為**
   - **攔截模式（肥米模式）**：`shift_toggle` 為 `false` 時，所有未明確處理的按鍵都會被攔截，不只是英文字母
     - 符號、標點符號等所有可列印字符都會被攔截
     - 功能鍵會讓事件通過（不攔截）：
       - F1-F24、方向鍵、Tab、CapsLock、NumLock、ScrollLock
       - Home、End、PageUp、PageDown、Insert、Delete
       - PrintScreen、Pause、Win鍵、Alt、Menu鍵
   - **不攔截模式（英模式）**：`shift_toggle` 為 `true` 時，所有按鍵都會通過，不進行任何處理
     - 英模式就是不攔截模式，由「單獨按一下 Shift」切換
     - 在英模式下，可以正常輸入英文和符號（包含 Shift+數字 輸出上排符號）

5. **輸入模式**
   - 目前實作剪貼簿貼上模式（**推薦用於遊戲環境**）
     - 兼容性最高，幾乎所有遊戲都支援 Ctrl+V 貼上
     - 不容易被反作弊系統檢測
     - 模擬真實用戶操作，符合用戶習慣
   - **遊戲模式窗口**（**支援 Raw Input 遊戲**）
     - 按 `Ctrl+Space` 或 `Ctrl+Alt` 打開遊戲模式窗口
     - 窗口獲得焦點後，直接接收鍵盤輸入（不依賴 `WH_KEYBOARD_LL` 鉤子）
     - 在窗口中輸入字根，選擇候選字後自動貼上到遊戲（使用 Ctrl+V）
     - **核心優勢**：能夠繞過 Raw Input 限制，因為窗口有焦點時，鍵盤事件直接發送到窗口
     - **使用場景**：適用於使用 Raw Input 或 DirectInput 的遊戲
   - 待實作：直接輸入模式（用於非遊戲環境，速度更快）、Big5 模式
   - 詳細說明請參考 [GAME_INPUT_COMPATIBILITY.md](GAME_INPUT_COMPATIBILITY.md)

### 與 Python 版行為差異（目前狀態）

為了先完成 Rust MVP，部分 Python 版的功能與細節尚未完整移植，這裡列出主要差異，方便比對：

- **出字方式**
  - Python：以「直接鍵盤輸出」為主（`SendKeysCtypes`），部分情境才用複製/貼上。
  - Rust：統一採用「剪貼簿 + Ctrl+V」貼上模式，簡化實作並提升遊戲相容性。

- **特殊應用程式處理**
  - Python：有 `f_arr` / `f_big5_arr` / `f_pass_app` 等白名單與黑名單，對特定程式強制使用 Big5、完全不啟用肥米、或改走貼上模式。
  - Rust：目前尚未移植這些 per‑app 特例處理，所有程式共用同一套行為。

- **半形 / 全形切換與 Shift+Space**
  - Python：`Shift+Space` 可以在半形/全形之間切換，當同音字清單顯示 `...` 時，`Shift+Space` 也可切換同音字下一頁。
  - Rust：尚未實作半形/全形模式與 `Shift+Space` 行為，現在的 Space 只負責：
    - 選第一個候選字或補碼選擇
    - 查不到候選時清除整組字根

- **同音字 / 注音 / 手機拼音等模式**
  - Python：有同音字查詢、注音查詢（`';zo6`）、手機拼音模式等多種輸入模式。
  - Rust：目前只實作「傳統肥米碼表」一種模式，尚未加入同音字查詢與注音/手機碼邏輯。

- **Big5 模式與多種輸出模式**
  - Python：支援 DEFAULT / BIG5 / PASTE 等多種 output type，Big5 模式會使用不同碼表與輸出路徑。
  - Rust：目前僅有剪貼簿貼上模式（UTF‑8），Big5 模式尚未移植。

- **「,,,」系列指令與 UI 操作**
  - Python：透過記錄 `last_key` 支援多種內建指令，例如：
    - `,,,VERSION` 顯示版本資訊
    - `,,,LOCK` / `,,,UNLOCK` 切換遊戲模式
    - `,,,C` / `,,,T` 簡繁模式、`,,,BOX` 自定詞庫視窗、UI 縮放 (`,,,S` / `,,,L` / `,,,+` / `,,,-`) 等
  - Rust：目前尚未實作這套「,,,」前綴指令與對應的 UI 操作。

- **其它**
  - Python：包含更多歷史相容性處理（Win7 / Win11 Notepad 特例、遠端桌面等）。
  - Rust：目前主要針對 Windows 10 / 11 現代環境優化，舊版系統與某些特殊程式的細節仍待補齊。

### 測試

專案包含完整的單元測試，覆蓋輸入法邏輯、鍵盤鉤子和遊戲模式窗口：

```bash
# 執行所有測試
cargo test

# 執行遊戲模式窗口測試（驗證 Raw Input 支援）
cargo test gui_window::tests

# 執行輸入法邏輯測試
cargo test input_method::tests

# 執行鍵盤鉤子測試
cargo test keyboard_hook::tests
```

詳細測試結果請參考 [TEST_RESULTS.md](TEST_RESULTS.md)

### 下一步開發重點

1. GUI 介面（候選字視窗顯示）
2. 模式切換（肥/英、半/全）
3. 多種輸入模式（直接輸入、Big5 模式）
4. 特殊應用程式處理（putty、notepad 等）

## 參考資料

- [Windows API 文件](https://docs.microsoft.com/en-us/windows/win32/api/)
- [windows-rs](https://github.com/microsoft/windows-rs)
- [enigo](https://github.com/enigo-rs/enigo)

